#!/usr/bin/env bash

# –û–±—â–∏–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏
LOCK_FILE="$HOME/.config/i3/config.d/.wallpaper_change.lock"
THEME_MODE_FILE="/tmp/.wallpaper_theme_mode"  # –í—Ä–µ–º–µ–Ω–Ω—ã–π —Ñ–∞–π–ª –≤ /tmp
I3_DIR="$HOME/.config/i3"
CURRENT_RICE=$(< "$I3_DIR/config.d/.rice")
CACHE_DIR="$HOME/.cache/$(whoami)/${CURRENT_RICE}"

# –ü—Ä–æ–≤–µ—Ä–∫–∞ –±–ª–æ–∫–∏—Ä–æ–≤–∫–∏
if [ -f "$LOCK_FILE" ]; then
    dunstify "‚ö†Ô∏è –û–±–æ–∏ —É–∂–µ –º–µ–Ω—è—é—Ç—Å—è!" "–ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ." -u low
    exit 1
fi
touch "$LOCK_FILE"
trap "rm -f '$LOCK_FILE'" EXIT INT TERM

# –§—É–Ω–∫—Ü–∏—è —Å–æ–∑–¥–∞–Ω–∏—è –º–∏–Ω–∏–∞—Ç—é—Ä
create_thumbnail() {
    local folder="$1" thumb="$2"
    first_img=$(find "$folder" -maxdepth 1 -type f \( -iname "*.jpg" -o -iname "*.jpeg" -o -iname "*.png" -o -iname "*.webp" \) | head -n1)
    if [ -n "$first_img" ]; then
        magick -strip "$first_img" -thumbnail 100x100^ -gravity center -extent 100x100 "$thumb"
    else
        magick -size 100x100 xc:gray "$thumb"
        echo "–ù–µ—Ç –æ–±–æ–µ–≤ –≤ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏ $folder" >&2
    fi
}

# –û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ —Ç–µ–º—ã –ø–æ –≤—Ä–µ–º–µ–Ω–∏
get_time_theme() {
    local hour=$(date +%H)
    if [ "$hour" -ge 6 ] && [ "$hour" -lt 18 ]; then
        echo "light"
    else
        echo "dark"
    fi
}

# –ü–æ–ª—É—á–∞–µ–º —Ç–µ–∫—É—â—É—é —Ç–µ–º—É
theme_mode=$(get_time_theme)
if [ -f "$THEME_MODE_FILE" ]; then
    theme_mode=$(< "$THEME_MODE_FILE")
fi

# –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ –º–∏–Ω–∏–∞—Ç—é—Ä
mkdir -p "$CACHE_DIR"
dark_thumb="$CACHE_DIR/dark_thumb.png"
light_thumb="$CACHE_DIR/light_thumb.png"
create_thumbnail "$I3_DIR/rices/${CURRENT_RICE}/walls/dark" "$dark_thumb"
create_thumbnail "$I3_DIR/rices/${CURRENT_RICE}/walls/light" "$light_thumb"

# –ú–µ–Ω—é –≤—ã–±–æ—Ä–∞ —Ç–µ–º—ã
rofi_command="rofi -dmenu -theme $I3_DIR/src/rofi-themes/WallSelect.rasi"
theme_choice=$(echo -e "dark\x00icon\x1f${dark_thumb}\nlight\x00icon\x1f${light_thumb}" | $rofi_command -p "–¢–µ–º–∞ –æ–±–æ–µ–≤")

if [ -n "$theme_choice" ]; then
    theme_mode="$theme_choice"
    echo "$theme_mode" > "$THEME_MODE_FILE"
fi

# –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ –∫—ç—à–∞ –æ–±–æ–µ–≤
wall_dir="$I3_DIR/rices/${CURRENT_RICE}/walls/${theme_mode}"
if [ ! -d "$wall_dir" ]; then
    dunstify "–û—à–∏–±–∫–∞" "–î–∏—Ä–µ–∫—Ç–æ—Ä–∏—è –æ–±–æ–µ–≤ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞: $wall_dir" -u critical
    exit 1
fi

find "$wall_dir" -maxdepth 1 -type f \( -iname "*.jpg" -o -iname "*.jpeg" -o -iname "*.png" -o -iname "*.webp" \) | while read -r img; do
    cached="$CACHE_DIR/$(basename "$img")"
    if [ ! -f "$cached" ]; then
        magick -strip "$img" -thumbnail 500x500^ -gravity center -extent 500x500 "$cached"
    fi
done

# –í—ã–±–æ—Ä –æ–±–æ–µ–≤ —á–µ—Ä–µ–∑ Rofi
wall_selection=$(find "$wall_dir" -maxdepth 1 -type f \( -iname "*.jpg" -o -iname "*.jpeg" -o -iname "*.png" -o -iname "*.webp" \) -exec basename {} \; | sort | while read -r img; do
    echo -e "$img\x00icon\x1f$CACHE_DIR/$img"
done | $rofi_command -p "–í—ã–±–µ—Ä–∏—Ç–µ –æ–±–æ–∏")

if [ -n "$wall_selection" ]; then
    # –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –æ–±–æ–µ–≤
    feh --no-fehbg --bg-fill "$wall_dir/$wall_selection"
    
    # –°–æ–∑–¥–∞–Ω–∏–µ –∏ –ø–æ–∫–∞–∑ –ø—Ä–µ–≤—å—é
    temp_preview="/tmp/wall_preview.png"
    magick "$wall_dir/$wall_selection" -resize 200x200^ -gravity center -extent 200x200 "$temp_preview"
    dunstify "üé® –û–±–æ–∏ –∏–∑–º–µ–Ω–µ–Ω—ã" "$wall_selection" -i "$temp_preview" -u normal
    rm -f "$temp_preview"
fi